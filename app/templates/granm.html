{% extends "base.html" %}

{% block title %}M√©todo Gran M - M√©todos de Optimizaci√≥n{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="fas fa-infinity text-success me-2"></i>M√©todo Gran M
        </h2>
    </div>
</div>

<div class="row">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-input-number me-2"></i>Datos del Problema
                </h5>
            </div>
            <div class="card-body">
                <!-- Math input section: allow intuitive mathematical language and convert to form -->
                <div class="mb-3">
                    <label for="math_input" class="form-label">Entrada en Lenguaje Matem√°tico (opcional):</label>
                    <textarea class="form-control" id="math_input" rows="3"
                        placeholder="Ejemplo: Z=3x1+2x2 sujeto a x1+x2=4; x1+2x2>=6"></textarea>
                    <div class="form-text">Puedes escribir la funci√≥n objetivo y restricciones en lenguaje matem√°tico;
                        luego haz clic en Convertir.</div>
                    <button type="button" class="btn btn-secondary mt-2" onclick="parseMathInput()">Convertir</button>
                </div>
                <form method="POST" action="{{ url_for('main.resolver_granm') }}">
                    <div class="mb-3">
                        <label for="c" class="form-label">Funci√≥n Objetivo (c):</label>
                        <input type="text" class="form-control" id="c" name="c" placeholder="Ej: 3,2,1"
                            value="{{ form_data.c if form_data else '' }}" required>
                        <div class="form-text">Coeficientes separados por comas</div>
                    </div>

                    <div class="mb-3">
                        <label for="A" class="form-label">Matriz de Restricciones (A):</label>
                        <textarea class="form-control" id="A" name="A" rows="4" placeholder="1,2,1&#10;2,1,3&#10;1,1,1"
                            required>{{ form_data.A if form_data else '' }}</textarea>
                        <div class="form-text">Una fila por l√≠nea, coeficientes separados por comas</div>
                    </div>

                    <div class="mb-3">
                        <label for="b" class="form-label">Vector de Recursos (b):</label>
                        <input type="text" class="form-control" id="b" name="b" placeholder="Ej: 12,8,6"
                            value="{{ form_data.b if form_data else '' }}" required>
                        <div class="form-text">Valores separados por comas</div>
                    </div>
                    <div class="mb-3">
                        <label for="eq_constraints" class="form-label">Restricciones de Igualdad:</label>
                        <input type="text" class="form-control" id="eq_constraints" name="eq_constraints"
                            placeholder="Ej: 0,2 (opcional)"
                            value="{{ form_data.eq_constraints if form_data else '' }}">
                        <div class="form-text">
                            <strong>√çndices de restricciones de igualdad (empezando desde 0), separados por
                                comas</strong><br>
                            <small class="text-muted">
                                üìù Ejemplo: Si tienes 3 restricciones y la primera y tercera son de igualdad (=),
                                escribe: 0,2<br>
                                ‚ö° Para tu problema actual: Si x‚ÇÅ + x‚ÇÇ = 4 es la primera restricci√≥n, escribe: 0
                            </small>
                        </div>
                    </div>
                    <!-- Nueva entrada: √≠ndices de restricciones ‚â• -->
                    <div class="mb-3">
                        <label for="ge_constraints" class="form-label">Restricciones ‚â• (√≠ndices):</label>
                        <input type="text" class="form-control" id="ge_constraints" name="ge_constraints"
                            placeholder="Ej: 1 (opcional)" value="{{ form_data.ge_constraints if form_data else '' }}">
                        <div class="form-text">
                            <strong>√çndices de restricciones ‚â•, separados por comas</strong><br>
                            <small class="text-muted">Ejemplo: si la segunda restricci√≥n es ‚â•, escribe: 1</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="M" class="form-label">Valor de M:</label>
                        <input type="number" class="form-control" id="M" name="M"
                            value="{{ form_data.M if form_data else '1000' }}" step="1" min="1">
                        <div class="form-text">Valor grande para penalizaci√≥n (por defecto: 1000)</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="minimize" name="minimize"
                                    {{ 'checked' if form_data and form_data.minimize else '' }}>
                                <label class="form-check-label" for="minimize">
                                    Minimizar (por defecto se maximiza)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="track_iterations"
                                    name="track_iterations" {{ 'checked' if form_data and form_data.track_iterations
                                    else '' }}>
                                <label class="form-check-label" for="track_iterations">
                                    Mostrar iteraciones
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-calculator me-2"></i>Resolver
                            </button>
                        </div>
                        <div class="col-md-6 mb-3">
                            <button type="submit" formaction="{{ url_for('main.generar_animacion_granm') }}"
                                class="btn btn-warning w-100">
                                <i class="fas fa-play me-2"></i>Resolver con Animaci√≥n
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        {% if resultado %}
        <div class="result-section">
            {% if resultado.success %}
            <h4 class="text-success mb-3">
                <i class="fas fa-check-circle me-2"></i>Soluci√≥n Encontrada
            </h4>
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Resultado:</h5>
                    <p class="mb-2">
                        <strong>Valor √≥ptimo:</strong> {{ "%.4f"|format(resultado.optimal_value) }}
                    </p>
                    {% if resultado.has_multiple_solutions %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>‚ö†Ô∏è Este problema tiene soluciones √≥ptimas m√∫ltiples.</strong>
                        {% if resultado.multiple_solution_vars %}
                        <br>
                        <small>Variables candidatas:
                            {% for var in resultado.multiple_solution_vars %}
                            x‚Çç{{ var + 1 }}‚Çé{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </small>
                        {% endif %}
                    </div>
                    <p class="mb-2">
                        <strong>Soluci√≥n base:</strong>
                        {% for val in resultado.solution %}
                        x‚Çç{{ loop.index }}‚Çé = {{ "%.4f"|format(val) }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </p>

                    {% if resultado.alternative_solutions %}
                    <div class="mt-3">
                        <h6><i class="fas fa-list-alt me-2"></i>Soluciones alternativas:</h6>
                        {% for alt_sol in resultado.alternative_solutions %}
                        <div class="card mt-2" style="border-left: 4px solid #28a745;">
                            <div class="card-body py-2">
                                <small class="text-muted">Pivoteando x‚Çç{{ alt_sol.entering_var + 1 }}‚Çé ‚Üí Base</small>
                                <p class="mb-0">
                                    <strong>Soluci√≥n {{ loop.index }}:</strong>
                                    {% for val in alt_sol.solution %}
                                    x‚Çç{{ loop.index }}‚Çé = {{ "%.4f"|format(val) }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                </p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% else %} <p class="mb-2">
                        <strong>Soluci√≥n:</strong>
                        {% for val in resultado.solution %}
                        x‚Çç{{ loop.index }}‚Çé = {{ "%.4f"|format(val) }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </p> {% endif %}
                </div>
            </div>

            {% if resultado.tableau_history %}
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-table me-2"></i>Iteraciones del Algoritmo
                    </h6>
                </div>
                <div class="card-body">
                    <div class="accordion" id="iterationsAccordion">
                        {% for i in range(resultado.tableau_history|length) %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading{{ i }}">
                                <button class="accordion-button {% if i != 0 %}collapsed{% endif %}" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#collapse{{ i }}">
                                    Iteraci√≥n {{ i + 1 }}
                                    {% if i < resultado.pivot_history|length %} <small class="ms-2 text-muted">
                                        (Pivote: fila {{ resultado.pivot_history[i][0] }}, columna {{
                                        resultado.pivot_history[i][1] }})
                                        </small>
                                        {% endif %}
                                </button>
                            </h2>
                            <div id="collapse{{ i }}" class="accordion-collapse collapse {% if i == 0 %}show{% endif %}"
                                data-bs-parent="#iterationsAccordion">
                                <div class="accordion-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm tableau-table">
                                            {% for row_idx in range(resultado.tableau_history[i]|length) %}
                                            <tr>
                                                {% for col_idx in range(resultado.tableau_history[i][row_idx]|length) %}
                                                <td
                                                    class="{% if i < resultado.pivot_history|length and row_idx == resultado.pivot_history[i][0] and col_idx == resultado.pivot_history[i][1] %}pivot-cell{% endif %}">
                                                    {{ "%.3f"|format(resultado.tableau_history[i][row_idx][col_idx]) }}
                                                </td>
                                                {% endfor %}
                                            </tr>
                                            {% endfor %}
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div> {% endif %}

            <!-- JSON Download Section -->
            {% if resultado and resultado.success %}
            <div class="json-download-section">
                <div class="card mt-3">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-download me-2"></i>Descargar Resultados
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-2">
                            <i class="fas fa-file-code me-2"></i>
                            Descarga los resultados completos en formato JSON para an√°lisis posterior
                        </p>
                        <form method="POST" action="{{ url_for('main.descargar_granm_json') }}" class="d-inline">
                            <!-- Hidden fields to preserve form data -->
                            <input type="hidden" name="c" value="{{ form_data.c if form_data else '' }}">
                            <input type="hidden" name="A" value="{{ form_data.A if form_data else '' }}">
                            <input type="hidden" name="b" value="{{ form_data.b if form_data else '' }}">
                            <input type="hidden" name="M" value="{{ form_data.M if form_data else '' }}"> <input
                                type="hidden" name="minimize"
                                value="{{ 'on' if form_data and form_data.minimize else '' }}">
                            <input type="hidden" name="track_iterations"
                                value="{{ 'on' if form_data and form_data.track_iterations else '' }}">

                            <!-- Hidden field for results -->
                            <input type="hidden" name="resultado_json" value="{{ resultado | tojson | e }}">

                            <button type="submit" class="btn btn-info btn-download-json">
                                <i class="fas fa-download me-2"></i>Descargar JSON
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endif %}

            {% if video_url %}
            <div class="card mt-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-film me-2"></i>Animaci√≥n del Proceso
                    </h5>
                </div>
                <div class="card-body text-center">
                    <video width="100%" height="400" controls>
                        <source src="{{ video_url }}" type="video/mp4">
                        Tu navegador no soporta el elemento de video.
                    </video>
                    <p class="mt-2 text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Animaci√≥n generada mostrando el proceso de resoluci√≥n paso a paso
                    </p>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<script src="{{ url_for('static', filename='js/examples.js') }}"></script>
<script>
    // Parse intuitive math input and populate form fields
    function parseMathInput() {
        // Read and normalize input
        let input = document.getElementById('math_input').value;
        if (!input) return;
        // Normalize subscript digits (‚ÇÄ‚Äì‚Çâ) to normal digits
        const subMap = { '‚ÇÄ': '0', '‚ÇÅ': '1', '‚ÇÇ': '2', '‚ÇÉ': '3', '‚ÇÑ': '4', '‚ÇÖ': '5', '‚ÇÜ': '6', '‚Çá': '7', '‚Çà': '8', '‚Çâ': '9' };
        input = input.replace(/[‚ÇÄ‚ÇÅ‚ÇÇ‚ÇÉ‚ÇÑ‚ÇÖ‚ÇÜ‚Çá‚Çà‚Çâ]/g, ch => subMap[ch]);
        // Detect MAX/MIN at start
        let minimizeFlag = false;
        const objMatch = input.match(/^\s*(MAX|MIN)\b/i);
        if (objMatch) {
            minimizeFlag = /^MIN/i.test(objMatch[1]);
            input = input.replace(/^\s*(MAX|MIN)\b/i, '').trim();
        }
        // Split objective and constraints by 'sujeto a', 's.a.' (Spanish) or 'subject to'
        const parts = input.split(/sujeto a|s\.a\.?|subject to/i);
        let objPart = parts[0].trim();
        if (/^Z=/i.test(objPart)) objPart = objPart.replace(/^Z=/i, '');
        // Match terms like '3x1', '+2x2', '-x3'
        const termPattern = /([+-]?\s*\d*\.?\d*)\s*x(\d+)/g;
        const coeffs = [];
        let match;
        while ((match = termPattern.exec(objPart)) !== null) {
            let val = match[1].replace(/\s+/g, '');
            if (val === '' || val === '+') val = '1';
            if (val === '-') val = '-1';
            coeffs[parseInt(match[2], 10) - 1] = parseFloat(val);
        }
        // Fill missing coefficients with 0
        for (let i = 0; i < coeffs.length; i++) if (coeffs[i] == null) coeffs[i] = 0;
        document.getElementById('c').value = coeffs.join(',');
        // Set minimize checkbox if applicable
        document.getElementById('minimize').checked = minimizeFlag;
        // Parse constraints
        const consPart = parts[1] || '';
        // Split constraints by semicolon or newlines (handling Windows CRLF)
        const rawCons = consPart.split(/;|\r?\n/).map(s => s.trim()).filter(Boolean);
        const A = [], b = [], eq = [];
        rawCons.forEach((constr, idx) => {
            const m = constr.match(/(.+?)(<=|>=|=)(.+)/);
            if (!m) return;
            const lhs = m[1].trim(), op = m[2], rhs = m[3].trim();
            const row = [];
            termPattern.lastIndex = 0;
            let t;
            while ((t = termPattern.exec(lhs)) !== null) {
                let v = t[1].replace(/\s+/g, '');
                if (v === '' || v === '+') v = '1';
                if (v === '-') v = '-1';
                row[parseInt(t[2], 10) - 1] = parseFloat(v);
            }
            for (let i = 0; i < coeffs.length; i++) if (row[i] == null) row[i] = 0;
            A.push(row.join(','));
            b.push(parseFloat(rhs));
            if (op === '=') eq.push(idx);
        });
        document.getElementById('A').value = A.join('\n');
        document.getElementById('b').value = b.join(',');
        document.getElementById('eq_constraints').value = eq.join(',');
    }
</script>
{% endblock %}