{% extends "base.html" %}

{% block title %}Método Gran M - Métodos de Optimización{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="fas fa-infinity text-success me-2"></i>Método Gran M
        </h2>
    </div>
</div>

<div class="row">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-input-number me-2"></i>Datos del Problema
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('main.resolver_granm') }}" id="granmForm">
                    <!-- Botones de ejemplo -->
                    <div class="mb-3" id="ejemplos-section-unique">
                        <label class="form-label fw-bold">
                            <i class="fas fa-star text-warning me-1"></i>Ejemplos Rápidos:
                        </label>
                        <div class="d-flex flex-wrap gap-2 mb-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                onclick="loadExample('granm', 0)" title="Gran M con igualdad">
                                <i class="fas fa-lightbulb me-1"></i>Ejemplo 1
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                onclick="loadExample('granm', 1)" title="Sistema mixto">
                                <i class="fas fa-lightbulb me-1"></i>Ejemplo 2
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                onclick="loadExample('granm', 2)" title="Minimización">
                                <i class="fas fa-lightbulb me-1"></i>Ejemplo 3
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                onclick="loadExample('granm', 3)" title="Ejercicio 1">
                                <i class="fas fa-lightbulb me-1"></i>Ejercicio 1
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                onclick="loadExample('granm', 4)" title="Ejercicio 2">
                                <i class="fas fa-lightbulb me-1"></i>Ejercicio 2
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                onclick="loadExample('granm', 5)" title="Ejercicio 3">
                                <i class="fas fa-lightbulb me-1"></i>Ejercicio 3
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                onclick="loadExample('granm', 6)" title="Ejercicio 4">
                                <i class="fas fa-lightbulb me-1"></i>Ejercicio 4
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                onclick="loadExample('granm', 7)" title="Ejercicio 5">
                                <i class="fas fa-lightbulb me-1"></i>Ejercicio 5
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                onclick="loadExample('granm', 8)" title="Ejercicio 6">
                                <i class="fas fa-lightbulb me-1"></i>Ejercicio 6
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearFormAdvanced()">
                                <i class="fas fa-eraser me-1"></i>Limpiar
                            </button>
                        </div>

                        <!-- Solución Esperada -->
                        <div id="expected-solution-container" class="mt-2" style="display: none;">
                            <div class="alert alert-info mb-0">
                                <h6 class="alert-heading mb-2">
                                    <i class="fas fa-info-circle me-1"></i>Solución Esperada:
                                </h6>
                                <div id="expected-solution-content"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Función Objetivo -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-target me-1 text-success"></i>Función Objetivo
                        </label>
                        <div class="card bg-light">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="me-2 fw-bold">Objetivo:</span>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="objective_type" id="maximize"
                                            value="maximize" checked>
                                        <label class="form-check-label" for="maximize">Maximizar</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="objective_type" id="minimize"
                                            value="minimize">
                                        <label class="form-check-label" for="minimize">Minimizar</label>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <span class="me-2">Variables:</span>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-secondary active"
                                            onclick="updateVariableCount(2)">2 variables</button>
                                        <button type="button" class="btn btn-outline-secondary"
                                            onclick="updateVariableCount(3)">3 variables</button>
                                        <button type="button" class="btn btn-outline-secondary"
                                            onclick="updateVariableCount(4)">4 variables</button>
                                        <button type="button" class="btn btn-outline-secondary"
                                            onclick="updateVariableCount(5)">5 variables</button>
                                    </div>
                                </div>
                                <div id="objective-function" class="d-flex flex-wrap align-items-center gap-2">
                                    <!-- Se generará dinámicamente -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Restricciones -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label fw-bold mb-0">
                                <i class="fas fa-list me-1 text-success"></i>Restricciones
                            </label>
                            <button type="button" class="btn btn-success btn-sm" onclick="addConstraint()">
                                <i class="fas fa-plus me-1"></i>Agregar Restricción
                            </button>
                        </div>
                        <div id="constraints-container">
                            <!-- Se generarán dinámicamente -->
                        </div>
                    </div>

                    <!-- Configuración del Método Gran M -->
                    <div class="mb-4">
                        <div class="card bg-warning bg-opacity-10">
                            <div class="card-body p-3">
                                <h6 class="card-title text-warning">
                                    <i class="fas fa-infinity me-1"></i>Configuración Gran M
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="M" class="form-label">Valor de M:</label>
                                        <input type="number" class="form-control" id="M" name="M" value="1000" step="1"
                                            min="1">
                                        <div class="form-text">Valor grande para penalización</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campos hidden para compatibilidad -->
                    <input type="hidden" id="c" name="c">
                    <input type="hidden" id="A" name="A">
                    <input type="hidden" id="b" name="b">
                    <input type="hidden" id="eq_constraints" name="eq_constraints">
                    <input type="hidden" id="ge_constraints" name="ge_constraints">
                    <input type="hidden" id="minimize_hidden" name="minimize"> <!-- Opciones adicionales -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="track_iterations"
                                    name="track_iterations" checked>
                                <label class="form-check-label" for="track_iterations">
                                    <i class="fas fa-history me-1"></i>Mostrar iteraciones del algoritmo
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Botón de resolver -->
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg" onclick="prepareFormDataGranM()">
                            <i class="fas fa-calculator me-2"></i>Resolver con Gran M
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        {% if resultado %}
        <div class="result-section">
            {% if resultado.success %}
            <h4 class="text-success mb-3">
                <i class="fas fa-check-circle me-2"></i>Solución Encontrada
            </h4>
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Resultado:</h5>
                    <p class="mb-2">
                        <strong>Valor óptimo:</strong> {{ "%.4f"|format(resultado.optimal_value) }}
                    </p>
                    {% if resultado.has_multiple_solutions %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>⚠️ Este problema tiene soluciones óptimas múltiples.</strong>
                        {% if resultado.multiple_solution_vars %}
                        <br>
                        <small>Variables candidatas:
                            {% for var in resultado.multiple_solution_vars %}
                            x₍{{ var + 1 }}₎{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </small>
                        {% endif %}
                    </div>
                    <p class="mb-2">
                        <strong>Solución base:</strong>
                        {% for val in resultado.solution %}
                        x₍{{ loop.index }}₎ = {{ "%.4f"|format(val) }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </p>

                    {% if resultado.alternative_solutions %}
                    <div class="mt-3">
                        <h6><i class="fas fa-list-alt me-2"></i>Soluciones alternativas:</h6>
                        {% for alt_sol in resultado.alternative_solutions %}
                        <div class="card mt-2" style="border-left: 4px solid #28a745;">
                            <div class="card-body py-2">
                                <small class="text-muted">Pivoteando x₍{{ alt_sol.entering_var + 1 }}₎ → Base</small>
                                <p class="mb-0">
                                    <strong>Solución {{ loop.index }}:</strong>
                                    {% for val in alt_sol.solution %}
                                    x₍{{ loop.index }}₎ = {{ "%.4f"|format(val) }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                </p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% else %} <p class="mb-2">
                        <strong>Solución:</strong>
                        {% for val in resultado.solution %}
                        x₍{{ loop.index }}₎ = {{ "%.4f"|format(val) }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </p> {% endif %}
                </div>
            </div>

            {% if resultado.tableau_history %}
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-table me-2"></i>Iteraciones del Algoritmo
                    </h6>
                </div>
                <div class="card-body">
                    <div class="accordion" id="iterationsAccordion">
                        {% for i in range(resultado.tableau_history|length) %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading{{ i }}">
                                <button class="accordion-button {% if i != 0 %}collapsed{% endif %}" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#collapse{{ i }}">
                                    Iteración {{ i + 1 }}
                                    {% if i < resultado.pivot_history|length %} <small class="ms-2 text-muted">
                                        (Pivote: fila {{ resultado.pivot_history[i][0] }}, columna {{
                                        resultado.pivot_history[i][1] }})
                                        </small>
                                        {% endif %}
                                </button>
                            </h2>
                            <div id="collapse{{ i }}" class="accordion-collapse collapse {% if i == 0 %}show{% endif %}"
                                data-bs-parent="#iterationsAccordion">
                                <div class="accordion-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm tableau-table">
                                            {% for row_idx in range(resultado.tableau_history[i]|length) %}
                                            <tr>
                                                {% for col_idx in range(resultado.tableau_history[i][row_idx]|length) %}
                                                <td
                                                    class="{% if i < resultado.pivot_history|length and row_idx == resultado.pivot_history[i][0] and col_idx == resultado.pivot_history[i][1] %}pivot-cell{% endif %}">
                                                    {{ "%.3f"|format(resultado.tableau_history[i][row_idx][col_idx]) }}
                                                </td>
                                                {% endfor %}
                                            </tr>
                                            {% endfor %}
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div> {% endif %}

            <!-- JSON Download Section -->
            {% if resultado and resultado.success %}
            <div class="json-download-section">
                <div class="card mt-3">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-download me-2"></i>Descargar Resultados
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-2">
                            <i class="fas fa-file-code me-2"></i>
                            Descarga los resultados completos en formato JSON para análisis posterior
                        </p>
                        <form method="POST" action="{{ url_for('main.descargar_granm_json') }}" class="d-inline">
                            <!-- Hidden fields to preserve form data -->
                            <input type="hidden" name="c" value="{{ form_data.c if form_data else '' }}">
                            <input type="hidden" name="A" value="{{ form_data.A if form_data else '' }}">
                            <input type="hidden" name="b" value="{{ form_data.b if form_data else '' }}">
                            <input type="hidden" name="M" value="{{ form_data.M if form_data else '' }}"> <input
                                type="hidden" name="minimize"
                                value="{{ 'on' if form_data and form_data.minimize else '' }}">
                            <input type="hidden" name="track_iterations"
                                value="{{ 'on' if form_data and form_data.track_iterations else '' }}">

                            <!-- Hidden field for results -->
                            <input type="hidden" name="resultado_json" value="{{ resultado | tojson | e }}">

                            <button type="submit" class="btn btn-info btn-download-json">
                                <i class="fas fa-download me-2"></i>Descargar JSON
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<script src="{{ url_for('static', filename='js/examples.js') }}"></script>
<script>
    // Parse intuitive math input and populate form fields
    function parseMathInput() {
        // Read and normalize input
        let input = document.getElementById('math_input').value;
        if (!input) return;
        // Normalize subscript digits (₀–₉) to normal digits
        const subMap = { '₀': '0', '₁': '1', '₂': '2', '₃': '3', '₄': '4', '₅': '5', '₆': '6', '₇': '7', '₈': '8', '₉': '9' };
        input = input.replace(/[₀₁₂₃₄₅₆₇₈₉]/g, ch => subMap[ch]);
        // Detect MAX/MIN at start
        let minimizeFlag = false;
        const objMatch = input.match(/^\s*(MAX|MIN)\b/i);
        if (objMatch) {
            minimizeFlag = /^MIN/i.test(objMatch[1]);
            input = input.replace(/^\s*(MAX|MIN)\b/i, '').trim();
        }
        // Split objective and constraints by 'sujeto a', 's.a.' (Spanish) or 'subject to'
        const parts = input.split(/sujeto a|s\.a\.?|subject to/i);
        let objPart = parts[0].trim();
        if (/^Z=/i.test(objPart)) objPart = objPart.replace(/^Z=/i, '');
        // Match terms like '3x1', '+2x2', '-x3'
        const termPattern = /([+-]?\s*\d*\.?\d*)\s*x(\d+)/g;
        const coeffs = [];
        let match;
        while ((match = termPattern.exec(objPart)) !== null) {
            let val = match[1].replace(/\s+/g, '');
            if (val === '' || val === '+') val = '1';
            if (val === '-') val = '-1';
            coeffs[parseInt(match[2], 10) - 1] = parseFloat(val);
        }
        // Fill missing coefficients with 0
        for (let i = 0; i < coeffs.length; i++) if (coeffs[i] == null) coeffs[i] = 0;
        document.getElementById('c').value = coeffs.join(',');
        // Set minimize checkbox if applicable
        document.getElementById('minimize').checked = minimizeFlag;
        // Parse constraints
        const consPart = parts[1] || '';
        // Split constraints by semicolon or newlines (handling Windows CRLF)
        const rawCons = consPart.split(/;|\r?\n/).map(s => s.trim()).filter(Boolean);
        const A = [], b = [], eq = [];
        rawCons.forEach((constr, idx) => {
            const m = constr.match(/(.+?)(<=|>=|=)(.+)/);
            if (!m) return;
            const lhs = m[1].trim(), op = m[2], rhs = m[3].trim();
            const row = [];
            termPattern.lastIndex = 0;
            let t;
            while ((t = termPattern.exec(lhs)) !== null) {
                let v = t[1].replace(/\s+/g, '');
                if (v === '' || v === '+') v = '1';
                if (v === '-') v = '-1';
                row[parseInt(t[2], 10) - 1] = parseFloat(v);
            }
            for (let i = 0; i < coeffs.length; i++) if (row[i] == null) row[i] = 0;
            A.push(row.join(','));
            b.push(parseFloat(rhs)); if (op === '=') eq.push(idx);
        });
        document.getElementById('A').value = A.join('\n');
        document.getElementById('b').value = b.join(',');
        document.getElementById('eq_constraints').value = eq.join(',');
    }
</script>

<script>
    // Variables globales para Gran M
    let variableCount = 2;
    let constraintCount = 2;    // Inicializar el formulario cuando se carga la página
    document.addEventListener('DOMContentLoaded', function () {
        initializeFormGranM();
        restoreFormDataGranM();
    });

    // Función para restaurar datos del formulario después de resolver (Gran M)
    function restoreFormDataGranM() {
        const formDataC = "{{ form_data.c if form_data else '' }}";
        const formDataA = "{{ form_data.A if form_data else '' }}";
        const formDataB = "{{ form_data.b if form_data else '' }}";
        const formDataEqConstraints = "{{ form_data.eq_constraints if form_data else '' }}";
        const formDataGeConstraints = "{{ form_data.ge_constraints if form_data else '' }}";
        const formDataMinimize = "{{ form_data.minimize if form_data else '' }}";
        const formDataTrackIterations = "{{ form_data.track_iterations if form_data else '' }}";
        const formDataM = "{{ form_data.M if form_data else '' }}";

        if (formDataC && formDataA && formDataB) {
            // Hay datos para restaurar
            const cValues = formDataC.split(',').map(v => parseFloat(v.trim()));
            const aRows = formDataA.split('\n').map(row => row.split(',').map(v => parseFloat(v.trim())));
            const bValues = formDataB.split(',').map(v => parseFloat(v.trim()));

            // Parsear restricciones especiales
            const eqConstraints = formDataEqConstraints ? formDataEqConstraints.split(',').map(v => parseInt(v.trim())) : [];
            const geConstraints = formDataGeConstraints ? formDataGeConstraints.split(',').map(v => parseInt(v.trim())) : [];

            // Determinar número de variables
            variableCount = cValues.length;

            // Actualizar botones de variables
            document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
            const buttonIndex = variableCount - 2; // Ajustar índice (2 variables = índice 0)
            if (buttonIndex >= 0 && buttonIndex < 4) {
                document.querySelectorAll('.btn-group .btn')[buttonIndex].classList.add('active');
            }

            // Configurar objetivo (minimizar/maximizar)
            if (formDataMinimize) {
                document.getElementById('minimize').checked = true;
            } else {
                document.getElementById('maximize').checked = true;
            }

            // Configurar track_iterations
            if (formDataTrackIterations) {
                document.getElementById('track_iterations').checked = true;
            }

            // Configurar valor de M
            if (formDataM) {
                document.getElementById('M').value = formDataM;
            }

            // Esperar un momento para que se genere la interfaz
            setTimeout(() => {
                // Restaurar coeficientes de la función objetivo
                cValues.forEach((val, i) => {
                    const input = document.getElementById(`obj_coef_${i}`);
                    if (input) input.value = val;
                });

                // Limpiar restricciones existentes
                document.getElementById('constraints-container').innerHTML = '';
                constraintCount = 0;

                // Restaurar restricciones
                aRows.forEach((row, rowIndex) => {
                    addConstraintGranM();

                    // Establecer coeficientes
                    row.forEach((coeff, colIndex) => {
                        const input = document.getElementById(`constraint_${rowIndex}_coef_${colIndex}`);
                        if (input) input.value = coeff;
                    });

                    // Establecer valor del lado derecho
                    const rhsInput = document.getElementById(`constraint_${rowIndex}_rhs`);
                    if (rhsInput && bValues[rowIndex] !== undefined) {
                        rhsInput.value = bValues[rowIndex];
                    }

                    // Establecer el signo de la restricción
                    const signSelect = document.getElementById(`constraint_${rowIndex}_sign`);
                    if (signSelect) {
                        if (eqConstraints.includes(rowIndex)) {
                            signSelect.value = '=';
                        } else if (geConstraints.includes(rowIndex)) {
                            signSelect.value = '>=';
                        } else {
                            signSelect.value = '<=';
                        }
                    }
                });
            }, 100);
            return true;
        }
        return false;
    }

    // Inicializar formulario con valores por defecto para Gran M
    function initializeFormGranM() {
        updateObjectiveFunction();
        initializeConstraintsGranM();
    }    // Actualizar número de variables
    function updateVariableCount(count) {
        variableCount = count;

        // Actualizar botones activos
        document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        updateObjectiveFunction();
        updateAllConstraintsGranM();
    }

    // Actualizar todas las restricciones existentes con el nuevo número de variables
    function updateAllConstraintsGranM() {
        const constraints = document.querySelectorAll('#constraints-container .card');

        constraints.forEach((constraint, constraintIndex) => {
            // Obtener valores existentes antes de regenerar
            const existingValues = {};
            const existingRHS = constraint.querySelector('.constraint-rhs')?.value || '1';
            const existingSign = constraint.querySelector('.constraint-sign')?.value || '<=';

            // Guardar valores existentes de coeficientes
            for (let i = 0; i < 10; i++) { // Buscar hasta 10 variables posibles
                const input = constraint.querySelector(`input[id$="_coef_${i}"]`);
                if (input) {
                    existingValues[i] = input.value;
                }
            }

            // Regenerar el contenido de la restricción
            const cardBody = constraint.querySelector('.card-body');
            let html = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="card-title mb-0 text-secondary">
                    <i class="fas fa-equals me-1"></i>Restricción ${constraintIndex + 1}
                </h6>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeConstraint(${constraintIndex})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="d-flex flex-wrap align-items-center gap-2">`;

            // Coeficientes de variables
            for (let i = 0; i < variableCount; i++) {
                if (i > 0) {
                    html += '<span class="text-muted">+</span>';
                }
                const savedValue = existingValues[i] || '1';
                html += `
                <div class="d-flex align-items-center">
                    <input type="number" step="0.1" class="form-control form-control-sm constraint-coef" 
                           style="width: 70px;" id="constraint_${constraintIndex}_coef_${i}" value="${savedValue}">
                    <span class="ms-1 fw-bold text-success">x₍${i + 1}₎</span>
                </div>`;
            }

            // Signo de la restricción y RHS
            html += `
                <select class="form-select form-select-sm constraint-sign" style="width: 80px;" id="constraint_${constraintIndex}_sign">
                    <option value="<=" ${existingSign === '<=' ? 'selected' : ''}>&leq;</option>
                    <option value=">=" ${existingSign === '>=' ? 'selected' : ''}>&geq;</option>
                    <option value="=" ${existingSign === '=' ? 'selected' : ''}>=</option>
                </select>
                
                <input type="number" step="0.1" class="form-control form-control-sm constraint-rhs" 
                       style="width: 80px;" id="constraint_${constraintIndex}_rhs" value="${existingRHS}" placeholder="RHS">
            </div>`;

            cardBody.innerHTML = html;
        });
    }

    // Generar función objetivo
    function updateObjectiveFunction() {
        const container = document.getElementById('objective-function');
        container.innerHTML = '';

        for (let i = 0; i < variableCount; i++) {
            if (i > 0) {
                const plus = document.createElement('span');
                plus.className = 'text-muted';
                plus.textContent = '+';
                container.appendChild(plus);
            }

            const group = document.createElement('div');
            group.className = 'd-flex align-items-center';

            const input = document.createElement('input');
            input.type = 'number';
            input.step = '0.1';
            input.className = 'form-control form-control-sm';
            input.style.width = '80px';
            input.value = i === 0 ? '2' : '3';
            input.id = `obj_coef_${i}`;

            const variable = document.createElement('span');
            variable.className = 'ms-1 fw-bold text-success';
            variable.textContent = `x₍${i + 1}₎`;

            group.appendChild(input);
            group.appendChild(variable);
            container.appendChild(group);
        }
    }

    // Inicializar restricciones por defecto para Gran M
    function initializeConstraintsGranM() {
        const container = document.getElementById('constraints-container');
        container.innerHTML = '';
        constraintCount = 0;

        // Agregar 2 restricciones por defecto
        addConstraint();
        addConstraint();

        // Establecer valores por defecto para Gran M
        setDefaultConstraintValuesGranM();
    }

    // Valores por defecto para las restricciones de Gran M
    function setDefaultConstraintValuesGranM() {
        // Restricción 1: 1x₁ + 1x₂ = 4
        if (document.getElementById('constraint_0_coef_0')) {
            document.getElementById('constraint_0_coef_0').value = '1';
            document.getElementById('constraint_0_coef_1').value = '1';
            document.getElementById('constraint_0_rhs').value = '4';
            document.getElementById('constraint_0_sign').value = '=';
        }

        // Restricción 2: 2x₁ + 1x₂ ≤ 6
        if (document.getElementById('constraint_1_coef_0')) {
            document.getElementById('constraint_1_coef_0').value = '2';
            document.getElementById('constraint_1_coef_1').value = '1';
            document.getElementById('constraint_1_rhs').value = '6';
            document.getElementById('constraint_1_sign').value = '<=';
        }
    }    // Agregar nueva restricción
    function addConstraint() {
        const container = document.getElementById('constraints-container');
        const constraintIndex = constraintCount;

        const constraintDiv = document.createElement('div');
        constraintDiv.className = 'card mb-2';
        constraintDiv.id = `constraint_${constraintIndex}`;

        let html = `
        <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="card-title mb-0 text-secondary">
                    <i class="fas fa-equals me-1"></i>Restricción ${constraintIndex + 1}
                </h6>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeConstraint(${constraintIndex})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="d-flex flex-wrap align-items-center gap-2">`;

        // Coeficientes de variables
        for (let i = 0; i < variableCount; i++) {
            if (i > 0) {
                html += '<span class="text-muted">+</span>';
            }
            html += `
            <div class="d-flex align-items-center">
                <input type="number" step="0.1" class="form-control form-control-sm constraint-coef" 
                       style="width: 70px;" id="constraint_${constraintIndex}_coef_${i}" value="1">
                <span class="ms-1 fw-bold text-success">x₍${i + 1}₎</span>
            </div>`;
        }

        // Signo de la restricción (incluye igualdad para Gran M)
        html += `
                <select class="form-select form-select-sm constraint-sign" style="width: 80px;" id="constraint_${constraintIndex}_sign">
                    <option value="<=">&leq;</option>
                    <option value=">=">&geq;</option>
                    <option value="=" selected>=</option>
                </select>
                
                <input type="number" step="0.1" class="form-control form-control-sm constraint-rhs" 
                       style="width: 80px;" id="constraint_${constraintIndex}_rhs" value="1" placeholder="RHS">
            </div>
        </div>`;

        constraintDiv.innerHTML = html;
        container.appendChild(constraintDiv);
        constraintCount++;
    }    // Eliminar restricción
    function removeConstraint(index) {
        const constraint = document.getElementById(`constraint_${index}`);
        if (constraint) {
            constraint.remove();
            updateConstraintLabelsAndIds();
        }
    }

    // Actualizar etiquetas e IDs de restricciones después de eliminar
    function updateConstraintLabelsAndIds() {
        const constraints = document.querySelectorAll('#constraints-container .card');
        constraintCount = constraints.length;

        constraints.forEach((constraint, index) => {
            // Actualizar ID del contenedor
            constraint.id = `constraint_${index}`;

            // Actualizar título
            const title = constraint.querySelector('.card-title');
            title.innerHTML = `<i class="fas fa-equals me-1"></i>Restricción ${index + 1}`;

            // Actualizar botón de eliminación
            const deleteBtn = constraint.querySelector('.btn-outline-danger');
            deleteBtn.setAttribute('onclick', `removeConstraint(${index})`);

            // Actualizar IDs de los inputs y selects
            const inputs = constraint.querySelectorAll('input[id^="constraint_"]');
            inputs.forEach(input => {
                const oldId = input.id;
                const parts = oldId.split('_');
                if (parts.length >= 3) {
                    if (parts[2] === 'coef') {
                        input.id = `constraint_${index}_coef_${parts[3]}`;
                    } else if (parts[2] === 'rhs') {
                        input.id = `constraint_${index}_rhs`;
                    }
                }
            });

            const select = constraint.querySelector('select[id^="constraint_"]');
            if (select) {
                select.id = `constraint_${index}_sign`;
            }
        });
    }

    // Preparar datos del formulario antes de enviar (específico para Gran M)
    function prepareFormDataGranM() {
        // Recopilar coeficientes de la función objetivo
        const objectiveCoefs = [];
        for (let i = 0; i < variableCount; i++) {
            const input = document.getElementById(`obj_coef_${i}`);
            objectiveCoefs.push(parseFloat(input.value) || 0);
        }
        document.getElementById('c').value = objectiveCoefs.join(',');

        // Recopilar restricciones
        const constraints = document.querySelectorAll('#constraints-container .card');
        const A = [];
        const b = [];
        const eq_constraints = [];
        const ge_constraints = [];

        constraints.forEach((constraint, index) => {
            const row = [];
            for (let i = 0; i < variableCount; i++) {
                const input = constraint.querySelector(`input[id$="_coef_${i}"]`);
                row.push(parseFloat(input?.value) || 0);
            }
            A.push(row.join(','));

            const rhsInput = constraint.querySelector('.constraint-rhs');
            b.push(parseFloat(rhsInput?.value) || 0);

            // Clasificar restricciones según su signo
            const signSelect = constraint.querySelector('.constraint-sign');
            const sign = signSelect?.value;
            if (sign === '=') {
                eq_constraints.push(index);
            } else if (sign === '>=') {
                ge_constraints.push(index);
            }
        });

        document.getElementById('A').value = A.join('\n');
        document.getElementById('b').value = b.join(',');
        document.getElementById('eq_constraints').value = eq_constraints.join(',');
        document.getElementById('ge_constraints').value = ge_constraints.join(',');

        // Tipo de optimización
        const isMinimize = document.getElementById('minimize').checked;
        document.getElementById('minimize_hidden').value = isMinimize ? 'on' : '';
    }    // Limpiar formulario mejorado
    function clearFormAdvanced() {
        // Resetear a valores por defecto
        variableCount = 2;
        document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector('.btn-group .btn:nth-child(1)').classList.add('active'); // 2 variables

        document.getElementById('maximize').checked = true;
        document.getElementById('track_iterations').checked = true;
        document.getElementById('M').value = '1000';

        // Ocultar solución esperada
        const expectedSolutionContainer = document.getElementById('expected-solution-container');
        if (expectedSolutionContainer) {
            expectedSolutionContainer.style.display = 'none';
        }

        initializeFormGranM();
    }

    // Función para cargar ejemplos (mejorada para Gran M)
    function loadExampleAdvanced(method, exampleIndex) {
        const example = examples[method][exampleIndex];
        if (!example) return;

        // Determinar número de variables
        const cValues = example.c.split(',');
        variableCount = cValues.length;

        // Actualizar botones de variables
        document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.btn-group .btn:nth-child(${variableCount - 1})`).classList.add('active');

        // Configurar objetivo
        document.getElementById(example.minimize ? 'minimize' : 'maximize').checked = true;

        updateObjectiveFunction();

        // Cargar coeficientes objetivo
        cValues.forEach((val, i) => {
            const input = document.getElementById(`obj_coef_${i}`);
            if (input) input.value = parseFloat(val);
        });

        // Cargar restricciones
        const ARows = example.A.split('\n');
        const bValues = example.b.split(',');
        const eqConstraints = example.eq_constraints ? example.eq_constraints.split(',').map(x => parseInt(x)) : [];

        // Limpiar restricciones existentes
        document.getElementById('constraints-container').innerHTML = '';
        constraintCount = 0;

        // Agregar restricciones del ejemplo
        ARows.forEach((row, rowIndex) => {
            addConstraint();
            const coeffs = row.split(',');
            coeffs.forEach((coeff, colIndex) => {
                const input = document.getElementById(`constraint_${rowIndex}_coef_${colIndex}`);
                if (input) input.value = parseFloat(coeff);
            });

            const rhsInput = document.getElementById(`constraint_${rowIndex}_rhs`);
            if (rhsInput && bValues[rowIndex]) {
                rhsInput.value = parseFloat(bValues[rowIndex]);
            }

            // Configurar signo de restricción
            const signSelect = document.getElementById(`constraint_${rowIndex}_sign`);
            if (signSelect) {
                if (eqConstraints.includes(rowIndex)) {
                    signSelect.value = '=';
                } else {
                    signSelect.value = '<='; // Por defecto
                }
            }
        });
    }

    // Reemplazar la función loadExample original
    function loadExample(method, exampleIndex) {
        loadExampleAdvanced(method, exampleIndex);
    }
</script>

<style>
    /* Estilos específicos para Gran M */
    .constraint-coef,
    .constraint-rhs {
        min-width: 70px;
    }

    .constraint-sign {
        min-width: 80px;
    }

    .card {
        transition: all 0.3s ease;
    }

    .card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Estilos para la solución esperada */
    #expected-solution-container {
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    #expected-solution-container .alert {
        border-left: 4px solid #198754;
        background: linear-gradient(135deg, #e8f5e8 0%, #f8f9fa 100%);
    }

    #expected-solution-container .badge {
        font-size: 0.85em;
        margin: 2px;
        padding: 6px 10px;
    }

    #expected-solution-container .alert-heading {
        color: #198754;
        font-size: 1rem;
    }

    .btn-group .btn {
        transition: all 0.2s ease;
    }

    .btn-group .btn.active {
        background-color: #198754;
        border-color: #198754;
        color: white;
    }

    .text-success {
        color: #198754 !important;
        font-weight: 600;
    }

    .bg-warning.bg-opacity-10 {
        background-color: rgba(255, 193, 7, 0.1) !important;
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .d-flex.flex-wrap {
            flex-direction: column;
            align-items: stretch !important;
        }

        .d-flex.flex-wrap .d-flex {
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .constraint-coef,
        .constraint-rhs,
        .constraint-sign {
            min-width: auto;
            width: 100%;
        }
    }
</style>

{% endblock %}