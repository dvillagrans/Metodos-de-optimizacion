{% extends "base.html" %}

{% block title %}Método Dos Fases - Métodos de Optimización{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="fas fa-layer-group text-warning me-2"></i>Método Dos Fases
        </h2>
    </div>
</div>

<div class="row">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-input-number me-2"></i>Datos del Problema
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('main.resolver_dosfases') }}" id="dosfasesForm">
                    <!-- Botones de ejemplo -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-star text-warning me-1"></i>Ejemplos Rápidos:
                        </label>
                        <div class="d-flex flex-wrap gap-2 mb-2"> <button type="button"
                                class="btn btn-outline-secondary btn-sm" onclick="loadDosFasesExample(0)">
                                <i class="fas fa-lightbulb me-1"></i>Ejercicio 1
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                onclick="loadDosFasesExample(1)">
                                <i class="fas fa-lightbulb me-1"></i>Ejercicio 2
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                onclick="loadDosFasesExample(2)">
                                <i class="fas fa-lightbulb me-1"></i>Ejercicio 3
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                onclick="loadDosFasesExample(3)">
                                <i class="fas fa-lightbulb me-1"></i>Ejercicio 4
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                onclick="loadDosFasesExample(4)">
                                <i class="fas fa-lightbulb me-1"></i>Ejercicio 5
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                onclick="loadDosFasesExample(5)">
                                <i class="fas fa-lightbulb me-1"></i>Ejercicio 6
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearForm()">
                                <i class="fas fa-eraser me-1"></i>Limpiar
                            </button>
                        </div>

                        <!-- Solución Esperada -->
                        <div id="expected-solution-container" class="mt-2" style="display: none;">
                            <div class="alert alert-info mb-0">
                                <h6 class="alert-heading mb-2">
                                    <i class="fas fa-info-circle me-1"></i>Solución Esperada:
                                </h6>
                                <div id="expected-solution-content"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Función Objetivo -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-target me-1 text-warning"></i>Función Objetivo
                        </label>
                        <div class="card bg-light">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="me-2 fw-bold">Objetivo:</span>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="objective_type" id="maximize"
                                            value="maximize" checked>
                                        <label class="form-check-label" for="maximize">Maximizar</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="objective_type" id="minimize"
                                            value="minimize">
                                        <label class="form-check-label" for="minimize">Minimizar</label>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <span class="me-2">Variables:</span>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-secondary"
                                            onclick="changeVariableCount(2)">2 variables</button>
                                        <button type="button" class="btn btn-outline-secondary active"
                                            onclick="changeVariableCount(3)">3 variables</button>
                                        <button type="button" class="btn btn-outline-secondary"
                                            onclick="changeVariableCount(4)">4 variables</button>
                                        <button type="button" class="btn btn-outline-secondary"
                                            onclick="changeVariableCount(5)">5 variables</button>
                                    </div>
                                </div>
                                <div id="objective-function" class="d-flex flex-wrap align-items-center gap-2">
                                    <!-- Se generará dinámicamente -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Restricciones -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label fw-bold mb-0">
                                <i class="fas fa-list me-1 text-success"></i>Restricciones
                            </label>
                            <button type="button" class="btn btn-success btn-sm" onclick="addConstraint()">
                                <i class="fas fa-plus me-1"></i>Agregar Restricción
                            </button>
                        </div>
                        <div id="constraints-container"> <!-- Se generarán dinámicamente -->
                        </div>
                    </div>

                    <!-- Opciones adicionales -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="track_iterations"
                                    name="track_iterations" checked>
                                <label class="form-check-label" for="track_iterations">
                                    <i class="fas fa-history me-1"></i>Mostrar iteraciones del algoritmo
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Botones de acción -->
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <button type="submit" class="btn btn-warning text-dark w-100">
                                <i class="fas fa-calculator me-2"></i>Resolver
                            </button>
                        </div>
                        <div class="col-md-6 mb-2">
                            <button type="button" class="btn btn-outline-secondary w-100" onclick="clearForm()">
                                <i class="fas fa-eraser me-2"></i>Limpiar
                            </button>
                        </div>
                    </div>
                </form> <!-- Scripts JavaScript para la interfaz dinámica -->
                <script>
                    // Variables globales
                    let variableCount = 3;
                    let constraintCount = 0;

                    // Función para cambiar el número de variables
                    function changeVariableCount(count) {
                        variableCount = count;

                        // Actualizar botones activos
                        document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
                        event.target.classList.add('active');

                        updateObjectiveFunction();
                        updateAllConstraints();

                        // Guardar los cambios en localStorage
                        setTimeout(() => {
                            saveFormDataToLocalStorage();
                        }, 100);
                    }

                    // Función para agregar eventos de auto-guardado a elementos
                    function addAutoSaveEvents(container = document) {
                        const inputs = container.querySelectorAll('input, select');
                        inputs.forEach(input => {
                            input.addEventListener('change', saveFormDataToLocalStorage);
                        });
                    }

                    // Función debounce para evitar guardado excesivo
                    function debounce(func, wait) {
                        let timeout;
                        return function executedFunction(...args) {
                            const later = () => {
                                clearTimeout(timeout);
                                func(...args);
                            };
                            clearTimeout(timeout);
                            timeout = setTimeout(later, wait);
                        };
                    }

                    // Función para actualizar la función objetivo
                    function updateObjectiveFunction() {
                        const container = document.getElementById('objective-function');
                        container.innerHTML = '';

                        for (let i = 0; i < variableCount; i++) {
                            const wrapper = document.createElement('div');
                            wrapper.className = 'd-flex align-items-center';

                            if (i > 0) {
                                const plus = document.createElement('span');
                                plus.className = 'me-2 text-warning fw-bold';
                                plus.textContent = '+';
                                wrapper.appendChild(plus);
                            }

                            const input = document.createElement('input');
                            input.type = 'number';
                            input.step = 'any';
                            input.className = 'form-control form-control-sm me-2';
                            input.style.width = '80px';
                            input.placeholder = '0';
                            input.id = `objective_coef_${i}`;

                            const label = document.createElement('span');
                            label.className = 'text-warning fw-bold me-2';
                            label.textContent = `x₍${i + 1}₎`;

                            wrapper.appendChild(input);
                            wrapper.appendChild(label);
                            container.appendChild(wrapper);
                        }

                        // Agregar eventos de auto-guardado a los nuevos inputs
                        addAutoSaveEvents(container);
                    }                    // Función para agregar nueva restricción
                    function addConstraint() {
                        const container = document.getElementById('constraints-container');
                        const constraintIndex = constraintCount;

                        const constraintDiv = document.createElement('div');
                        constraintDiv.className = 'card mb-2';
                        constraintDiv.id = `constraint_${constraintIndex}`;

                        let html = `
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-bold text-success">Restricción ${constraintIndex + 1}</span>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeConstraint(${constraintIndex})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="d-flex flex-wrap align-items-center gap-2">`;

                        // Coeficientes de variables
                        for (let i = 0; i < variableCount; i++) {
                            if (i > 0) {
                                html += `<span class="text-warning fw-bold">+</span>`;
                            }
                            html += `
                            <input type="number" step="any" class="form-control form-control-sm constraint-coef" 
                                   style="width: 80px;" placeholder="0" id="constraint_${constraintIndex}_coef_${i}">
                            <span class="text-warning fw-bold">x₍${i + 1}₎</span>`;
                        }

                        // Signo de la restricción (para dos fases, típicamente =)
                        html += `
                                <select class="form-select form-select-sm constraint-sign" style="width: 80px;" id="constraint_${constraintIndex}_sign">
                                    <option value="<=">&le;</option>
                                    <option value=">=">&ge;</option>
                                    <option value="=" selected>=</option>
                                </select>
                                <input type="number" step="any" class="form-control form-control-sm constraint-rhs" 
                                       style="width: 80px;" placeholder="0" id="constraint_${constraintIndex}_rhs">
                            </div>
                        </div>`;

                        constraintDiv.innerHTML = html;
                        container.appendChild(constraintDiv);
                        constraintCount++;

                        // Agregar eventos de auto-guardado a los nuevos inputs
                        addAutoSaveEvents(constraintDiv);

                        // Guardar cambios en localStorage
                        setTimeout(() => {
                            saveFormDataToLocalStorage();
                        }, 100);
                    }

                    // Función para eliminar restricción
                    function removeConstraint(index) {
                        const constraint = document.getElementById(`constraint_${index}`);
                        if (constraint) {
                            constraint.remove();
                            updateConstraintLabels();
                            saveFormDataToLocalStorage();
                        }
                    }

                    // Función para actualizar etiquetas de restricciones
                    function updateConstraintLabels() {
                        const constraints = document.querySelectorAll('#constraints-container .card');
                        constraints.forEach((constraint, index) => {
                            const label = constraint.querySelector('.fw-bold.text-success');
                            if (label) {
                                label.textContent = `Restricción ${index + 1}`;
                            }
                        });
                    }

                    // Función para actualizar todas las restricciones cuando cambia el número de variables
                    function updateAllConstraints() {
                        const constraints = document.querySelectorAll('#constraints-container .card');
                        constraints.forEach((constraint, constraintIndex) => {
                            const cardBody = constraint.querySelector('.card-body');
                            let html = `
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-bold text-success">Restricción ${constraintIndex + 1}</span>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeConstraint(${constraintIndex})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="d-flex flex-wrap align-items-center gap-2">`;

                            for (let i = 0; i < variableCount; i++) {
                                if (i > 0) {
                                    html += `<span class="text-warning fw-bold">+</span>`;
                                }
                                html += `
                                <input type="number" step="any" class="form-control form-control-sm constraint-coef" 
                                       style="width: 80px;" placeholder="0" id="constraint_${constraintIndex}_coef_${i}">
                                <span class="text-warning fw-bold">x₍${i + 1}₎</span>`;
                            }

                            html += `
                                <select class="form-select form-select-sm constraint-sign" style="width: 80px;" id="constraint_${constraintIndex}_sign">
                                    <option value="<=">&le;</option>
                                    <option value=">=">&ge;</option>
                                    <option value="=" selected>=</option>
                                </select>
                                <input type="number" step="any" class="form-control form-control-sm constraint-rhs" 
                                       style="width: 80px;" placeholder="0" id="constraint_${constraintIndex}_rhs">
                            </div>`;
                            cardBody.innerHTML = html;
                        });

                        // Agregar eventos de auto-guardado a los elementos actualizados                        addAutoSaveEvents();
                    } function prepareFormData() {
                        // Preparar función objetivo
                        const c = [];
                        for (let i = 0; i < variableCount; i++) {
                            const input = document.getElementById(`objective_coef_${i}`);
                            const val = input ? input.value : '';
                            c.push(val === '' ? 0 : parseFloat(val));
                        }

                        // Crear o actualizar campo oculto para c
                        let cField = document.getElementById('c_hidden');
                        if (!cField) {
                            cField = document.createElement('input');
                            cField.type = 'hidden';
                            cField.name = 'c';
                            cField.id = 'c_hidden';
                            document.getElementById('dosfasesForm').appendChild(cField);
                        }
                        cField.value = c.join(',');

                        // Preparar restricciones
                        const A = [];
                        const b = [];
                        const eqConstraints = [];
                        const geConstraints = [];

                        const constraints = document.querySelectorAll('#constraints-container .card');
                        constraints.forEach((constraint, index) => {
                            const row = [];
                            for (let j = 0; j < variableCount; j++) {
                                const input = constraint.querySelector(`#constraint_${index}_coef_${j}`);
                                const val = input ? input.value : '';
                                row.push(val === '' ? 0 : parseFloat(val));
                            }
                            A.push(row);

                            const rhsInput = constraint.querySelector(`#constraint_${index}_rhs`);
                            const rhsVal = rhsInput ? rhsInput.value : '';
                            b.push(rhsVal === '' ? 0 : parseFloat(rhsVal));

                            const signSelect = constraint.querySelector(`#constraint_${index}_sign`);
                            const sign = signSelect ? signSelect.value : '<=';
                            if (sign === '=') {
                                eqConstraints.push(index);
                            } else if (sign === '>=') {
                                geConstraints.push(index);
                            }
                        });

                        // Crear o actualizar campos ocultos
                        let aField = document.getElementById('A_hidden');
                        if (!aField) {
                            aField = document.createElement('input');
                            aField.type = 'hidden';
                            aField.name = 'A';
                            aField.id = 'A_hidden';
                            document.getElementById('dosfasesForm').appendChild(aField);
                        }
                        aField.value = A.map(row => row.join(',')).join('\n');

                        let bField = document.getElementById('b_hidden');
                        if (!bField) {
                            bField = document.createElement('input');
                            bField.type = 'hidden';
                            bField.name = 'b';
                            bField.id = 'b_hidden';
                            document.getElementById('dosfasesForm').appendChild(bField);
                        }
                        bField.value = b.join(',');

                        let eqField = document.getElementById('eq_constraints_hidden');
                        if (!eqField) {
                            eqField = document.createElement('input');
                            eqField.type = 'hidden';
                            eqField.name = 'eq_constraints';
                            eqField.id = 'eq_constraints_hidden';
                            document.getElementById('dosfasesForm').appendChild(eqField);
                        }
                        eqField.value = eqConstraints.join(',');

                        let geField = document.getElementById('ge_constraints_hidden');
                        if (!geField) {
                            geField = document.createElement('input');
                            geField.type = 'hidden';
                            geField.name = 'ge_constraints';
                            geField.id = 'ge_constraints_hidden';
                            document.getElementById('dosfasesForm').appendChild(geField);
                        }
                        geField.value = geConstraints.join(',');

                        // Preparar objetivo (minimizar/maximizar)
                        const isMinimize = document.querySelector('input[name="objective_type"]:checked').value === 'minimize';
                        let minimizeHidden = document.getElementById('minimize_hidden');
                        if (!minimizeHidden) {
                            minimizeHidden = document.createElement('input');
                            minimizeHidden.type = 'hidden';
                            minimizeHidden.name = 'minimize';
                            minimizeHidden.id = 'minimize_hidden';
                            document.getElementById('dosfasesForm').appendChild(minimizeHidden);
                        }
                        minimizeHidden.value = isMinimize ? '1' : '0';
                    }

                    function loadDosFasesExample(exampleIndex) {
                        console.log('loadDosFasesExample called with:', exampleIndex);
                        console.log('window.examples:', !!window.examples);
                        console.log('window.examples.dosfases:', !!window.examples?.dosfases);
                        if (window.examples && window.examples.dosfases) {
                            const example = window.examples.dosfases[exampleIndex];
                            console.log('Found example:', example);

                            if (!example) {
                                console.error('Ejemplo no encontrado:', exampleIndex);
                                return;
                            }

                            // Configurar número de variables según el ejemplo
                            const cValues = example.c.split(',');
                            const newVariableCount = cValues.length;

                            if (variableCount !== newVariableCount) {
                                variableCount = newVariableCount;
                                updateButtonGroup();
                                updateObjectiveFunction();
                            }

                            // Limpiar restricciones existentes
                            clearConstraints();

                            // Configurar objetivo (maximizar/minimizar)
                            const objectiveType = example.minimize ? 'minimize' : 'maximize';
                            document.querySelector(`input[name="objective_type"][value="${objectiveType}"]`).checked = true;

                            // Configurar función objetivo con timeout para asegurar que los elementos estén listos
                            setTimeout(() => {
                                cValues.forEach((value, index) => {
                                    const input = document.getElementById(`objective_coef_${index}`);
                                    if (input) {
                                        input.value = parseFloat(value);
                                    }
                                });

                                // Cargar restricciones
                                const AMatrix = example.A.split('\n');
                                const bValues = example.b.split(',');
                                const eqConstraints = example.eq_constraints ? example.eq_constraints.split(',').map(i => parseInt(i)) : [];
                                const geConstraints = example.ge_constraints ? example.ge_constraints.split(',').map(i => parseInt(i)) : [];

                                // Añadir restricciones una por una
                                AMatrix.forEach((row, index) => {
                                    addConstraint();
                                });

                                // Configurar restricciones con otro timeout
                                setTimeout(() => {
                                    AMatrix.forEach((row, index) => {
                                        const coefficients = row.split(',');

                                        // Llenar coeficientes
                                        coefficients.forEach((coeff, coeffIndex) => {
                                            const input = document.getElementById(`constraint_${index}_coef_${coeffIndex}`);
                                            if (input) {
                                                input.value = parseFloat(coeff);
                                            }
                                        });

                                        // Configurar valor b
                                        const rhsInput = document.getElementById(`constraint_${index}_rhs`);
                                        if (rhsInput) {
                                            rhsInput.value = parseFloat(bValues[index]);
                                        }

                                        // Configurar tipo de restricción
                                        const signSelect = document.getElementById(`constraint_${index}_sign`);
                                        if (signSelect) {
                                            let constraintType = '<='; // Por defecto
                                            if (eqConstraints.includes(index)) {
                                                constraintType = '=';
                                            } else if (geConstraints.includes(index)) {
                                                constraintType = '>=';
                                            }
                                            signSelect.value = constraintType;
                                        }
                                    });                                    // Mostrar solución esperada si existe
                                    console.log('Checking showExpectedSolutionGeneric...', !!window.showExpectedSolutionGeneric);
                                    console.log('Example:', example);
                                    console.log('Expected solution:', example.expected_solution);

                                    if (window.showExpectedSolutionGeneric) {
                                        window.showExpectedSolutionGeneric(example);
                                    } else {
                                        console.error('showExpectedSolutionGeneric not available');
                                    }

                                    // Mostrar notificación
                                    console.log(`Ejemplo cargado: ${example.name}`);
                                }, 200);
                            }, 100);
                        } else {
                            console.error('Conditions not met:', {
                                hasWindowExamples: !!window.examples,
                                hasDosfasesExamples: !!window.examples?.dosfases
                            });
                        }
                        saveFormDataToLocalStorage();
                    }

                    function clearForm() {
                        clearConstraints();
                        updateObjectiveFunction();
                        document.querySelector('input[name="objective_type"][value="maximize"]').checked = true;

                        // Ocultar solución esperada
                        const expectedSolutionContainer = document.getElementById('expected-solution-container');
                        if (expectedSolutionContainer) {
                            expectedSolutionContainer.style.display = 'none';
                        }

                        saveFormDataToLocalStorage();
                    }

                    function clearConstraints() {
                        const container = document.getElementById('constraints-container');
                        container.innerHTML = '';
                        constraintCount = 0;
                    }

                    function updateButtonGroup() {
                        document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
                        document.querySelector(`.btn-group .btn:nth-child(${variableCount - 1})`).classList.add('active');
                    }

                    function saveFormDataToLocalStorage() {
                        // Implementar si es necesario
                    }

                    // Preparar datos antes de enviar el formulario
                    document.getElementById('dosfasesForm').addEventListener('submit', function (e) {
                        prepareFormData();
                    });

                    // Inicialización
                    document.addEventListener('DOMContentLoaded', function () {
                        updateObjectiveFunction();
                        addConstraint(); // Agregar una restricción por defecto
                    });
                    document.getElementById('track_iterations').checked = false;                    // Preparar datos antes de enviar el formulario
                    document.getElementById('dosfasesForm').addEventListener('submit', function (e) {
                        prepareFormData();
                    });// Inicializar la interfaz
                    document.addEventListener('DOMContentLoaded', function () {
                        // Verificar si hay datos del formulario para restaurar
                        restoreFormDataDosFases();
                        updateVariables();
                    });

                    // Función para restaurar datos del formulario después de resolver (Dos Fases)
                    function restoreFormDataDosFases() {
                        const formDataC = "{{ form_data.c if form_data else '' }}";
                        const formDataA = "{{ form_data.A if form_data else '' }}";
                        const formDataB = "{{ form_data.b if form_data else '' }}";
                        const formDataEqConstraints = "{{ form_data.eq_constraints if form_data else '' }}";
                        const formDataGeConstraints = "{{ form_data.ge_constraints if form_data else '' }}";
                        const formDataMinimize = "{{ form_data.minimize if form_data else '' }}";
                        const formDataTrackIterations = "{{ form_data.track_iterations if form_data else '' }}";

                        if (formDataC && formDataA && formDataB) {
                            // Hay datos para restaurar
                            const cValues = formDataC.split(',').map(v => parseFloat(v.trim()));
                            const aRows = formDataA.split('\n').map(row => row.split(',').map(v => parseFloat(v.trim())));
                            const bValues = formDataB.split(',').map(v => parseFloat(v.trim()));

                            // Parsear restricciones especiales
                            const eqConstraints = formDataEqConstraints ? formDataEqConstraints.split(',').map(v =>
                                parseInt(v.trim())) : [];
                            const geConstraints = formDataGeConstraints ? formDataGeConstraints.split(',').map(v =>
                                parseInt(v.trim())) : [];

                            // Determinar número de variables
                            numVars = cValues.length;
                            numConstraints = aRows.length;

                            // Actualizar el selector de número de variables
                            document.getElementById('numVariables').value = numVars;

                            // Configurar objetivo (minimizar/maximizar)
                            if (formDataMinimize) {
                                document.getElementById('minimize').checked = true;
                            }

                            // Configurar track_iterations
                            if (formDataTrackIterations) {
                                document.getElementById('track_iterations').checked = true;
                            }

                            // Esperar un momento para que se genere la interfaz
                            setTimeout(() => {
                                // Generar la interfaz con el número correcto de variables
                                generateObjectiveInputs();
                                generateConstraintInputs();

                                // Restaurar coeficientes de la función objetivo
                                cValues.forEach((val, i) => {
                                    const input = document.getElementById(`c_${i}`);
                                    if (input) input.value = val;
                                });

                                // Restaurar restricciones
                                aRows.forEach((row, rowIndex) => {
                                    // Establecer coeficientes
                                    row.forEach((coeff, colIndex) => {
                                        const input = document.getElementById(`a_${rowIndex}_${colIndex}`);
                                        if (input) input.value = coeff;
                                    });

                                    // Establecer valor del lado derecho
                                    const rhsInput = document.getElementById(`b_${rowIndex}`);
                                    if (rhsInput && bValues[rowIndex] !== undefined) {
                                        rhsInput.value = bValues[rowIndex];
                                    }

                                    // Establecer el signo de la restricción
                                    const signSelect = document.getElementById(`sign_${rowIndex}`);
                                    if (signSelect) {
                                        if (eqConstraints.includes(rowIndex)) {
                                            signSelect.value = '=';
                                        } else if (geConstraints.includes(rowIndex)) {
                                            signSelect.value = '>=';
                                        } else {
                                            signSelect.value = '<=';
                                        }
                                    }
                                });
                            }, 100);
                        }
                    } </script> <!-- Estilos CSS adicionales -->
                <style>
                    /* Estilos para el formulario mejorado */
                    .constraint-coef,
                    .constraint-rhs {
                        min-width: 70px;
                    }

                    .constraint-sign {
                        min-width: 80px;
                    }

                    .card {
                        transition: all 0.3s ease;
                    }

                    .card:hover {
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    }

                    /* Estilos para la solución esperada */
                    #expected-solution-container {
                        animation: fadeIn 0.5s ease-in;
                    }

                    @keyframes fadeIn {
                        from {
                            opacity: 0;
                            transform: translateY(-10px);
                        }

                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }

                    #expected-solution-container .alert {
                        border-left: 4px solid #ffc107;
                        background: linear-gradient(135deg, #fff3cd 0%, #f8f9fa 100%);
                    }

                    #expected-solution-container .badge {
                        font-size: 0.85em;
                        margin: 2px;
                        padding: 6px 10px;
                    }

                    #expected-solution-container .alert-heading {
                        color: #856404;
                        font-size: 1rem;
                    }

                    .btn-group .btn {
                        transition: all 0.2s ease;
                    }

                    .btn-group .btn.active {
                        background-color: #ffc107;
                        border-color: #ffc107;
                        color: #212529;
                        font-weight: 600;
                    }

                    .form-control-sm {
                        font-size: 0.875rem;
                    }

                    .text-warning {
                        font-weight: 600;
                    }

                    .gap-2 {
                        gap: 0.5rem !important;
                    }

                    /* Animaciones suaves */
                    .card-body {
                        transition: all 0.3s ease;
                    }

                    /* Mejorar el spacing */
                    .d-flex.align-items-center {
                        min-height: 38px;
                    }

                    /* Estilos para los inputs numéricos */
                    input[type="number"] {
                        text-align: center;
                    }

                    /* Mejorar la apariencia de los radio buttons */
                    .form-check-input:checked {
                        background-color: #ffc107;
                        border-color: #ffc107;
                    }

                    /* Estilos para las etiquetas de variables */
                    .text-warning {
                        color: #ffc107 !important;
                    }

                    /* Estilos específicos para dos fases */
                    .coefficient-group {
                        display: inline-flex;
                        align-items: center;
                        flex-direction: column;
                        text-align: center;
                    }

                    .btn-download-json {
                        background: linear-gradient(45deg, #28a745, #20c997);
                        border: none;
                        transition: all 0.3s ease;
                    }

                    .btn-download-json:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
                    }

                    /* Mejorar el diseño responsive */
                    @media (max-width: 768px) {
                        .d-flex.flex-wrap {
                            flex-direction: column;
                            align-items: stretch !important;
                        }

                        .d-flex.flex-wrap .d-flex {
                            justify-content: space-between;
                            margin-bottom: 0.5rem;
                        }

                        .constraint-coef,
                        .constraint-rhs,
                        .constraint-sign {
                            min-width: auto;
                            width: 100%;
                        }

                        .coefficient-group {
                            margin-bottom: 10px;
                        }
                    }

                    /* Estilos para distinguir las fases del algoritmo */
                    .iteration-phase-one .accordion-button {
                        background-color: #fff8e1 !important;
                        border-left: 4px solid #ffc107 !important;
                    }

                    .iteration-phase-one .accordion-button:not(.collapsed) {
                        background-color: #ffeaa7 !important;
                        color: #212529 !important;
                        box-shadow: inset 0 -1px 0 rgba(255, 193, 7, 0.125) !important;
                    }

                    .iteration-phase-two .accordion-button {
                        background-color: #e3f2fd !important;
                        border-left: 4px solid #0d6efd !important;
                    }

                    .iteration-phase-two .accordion-button:not(.collapsed) {
                        background-color: #bbdefb !important;
                        color: #212529 !important;
                        box-shadow: inset 0 -1px 0 rgba(13, 110, 253, 0.125) !important;
                    }

                    .phase-one-body {
                        background-color: #fffbf0 !important;
                        border-left: 4px solid #ffc107;
                    }

                    .phase-two-body {
                        background-color: #f8fbff !important;
                        border-left: 4px solid #0d6efd;
                    }

                    .phase-one-table {
                        background-color: #fffef7 !important;
                    }

                    .phase-one-table thead th {
                        background-color: #ffeaa7 !important;
                        color: #212529 !important;
                        border-color: #ffc107 !important;
                    }

                    .phase-one-table tbody tr:nth-child(even) {
                        background-color: #fff8e1 !important;
                    }

                    .phase-two-table {
                        background-color: #fbfcff !important;
                    }

                    .phase-two-table thead th {
                        background-color: #bbdefb !important;
                        color: #212529 !important;
                        border-color: #0d6efd !important;
                    }

                    .phase-two-table tbody tr:nth-child(even) {
                        background-color: #e3f2fd !important;
                    }

                    /* Estilo para el elemento pivote mantiene su color original */
                    .pivot-cell {
                        background-color: #dc3545 !important;
                        color: white !important;
                        font-weight: bold !important;
                    }

                    /* Efectos hover para las tablas de las fases */
                    .phase-one-table tbody tr:hover {
                        background-color: #ffecb3 !important;
                    }

                    .phase-two-table tbody tr:hover {
                        background-color: #c5cae9 !important;
                    }

                    /* Badges específicos para las fases */
                    .badge.bg-warning.text-dark {
                        background-color: #ffc107 !important;
                        color: #212529 !important;
                        font-weight: 600;
                        text-shadow: none;
                    }

                    .badge.bg-primary {
                        background-color: #0d6efd !important;
                        color: white !important;
                        font-weight: 600;
                    }
                </style>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        {% if resultado %}
        <div class="result-section">
            {% if resultado.success %}
            <h4 class="text-success mb-3">
                <i class="fas fa-check-circle me-2"></i>Solución Encontrada
            </h4>
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Resultado:</h5>
                    <p class="mb-2">
                        <strong>Valor óptimo:</strong> {{ "%.4f"|format(resultado.optimal_value) }}
                    </p>
                    {% if resultado.has_multiple_solutions %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>⚠️ Este problema tiene soluciones óptimas múltiples.</strong>
                        {% if resultado.multiple_solution_vars %}
                        <br>
                        <small>Variables candidatas:
                            {% for var in resultado.multiple_solution_vars %}
                            x₍{{ var + 1 }}₎{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </small>
                        {% endif %}
                    </div>
                    <p class="mb-2">
                        <strong>Solución base:</strong>
                        {% for val in resultado.solution %}
                        x₍{{ loop.index }}₎ = {{ "%.4f"|format(val) }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </p>

                    {% if resultado.alternative_solutions %}
                    <div class="mt-3">
                        <h6><i class="fas fa-list-alt me-2"></i>Soluciones alternativas:</h6>
                        {% for alt_sol in resultado.alternative_solutions %}
                        <div class="card mt-2" style="border-left: 4px solid #ffc107;">
                            <div class="card-body py-2">
                                <small class="text-muted">Pivoteando x₍{{ alt_sol.entering_var + 1 }}₎ → Base</small>
                                <p class="mb-0">
                                    <strong>Solución {{ loop.index }}:</strong>
                                    {% for val in alt_sol.solution %}
                                    x₍{{ loop.index }}₎ = {{ "%.4f"|format(val) }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                </p>
                            </div>
                        </div> {% endfor %}
                    </div>
                    {% endif %}
                    {% else %}
                    <p class="mb-2">
                        <strong>Solución:</strong>
                        {% for val in resultado.solution %}
                        x₍{{ loop.index }}₎ = {{ "%.4f"|format(val) }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </p>
                    {% endif %}
                </div>
            </div>
            <!-- Botón para descargar JSON -->
            <div class="json-download-section">
                <form method="POST" action="{{ url_for('main.descargar_dosfases_json') }}" class="d-inline">
                    <!-- Hidden fields to preserve form data -->
                    <input type="hidden" name="c" value="{{ form_data.c if form_data else '' }}">
                    <input type="hidden" name="A" value="{{ form_data.A if form_data else '' }}">
                    <input type="hidden" name="b" value="{{ form_data.b if form_data else '' }}">
                    <input type="hidden" name="eq_constraints"
                        value="{{ form_data.eq_constraints if form_data else '' }}">
                    <input type="hidden" name="minimize" value="{{ 'on' if form_data and form_data.minimize else '' }}">
                    <input type="hidden" name="track_iterations"
                        value="{{ 'on' if form_data and form_data.track_iterations else '' }}">

                    <!-- Hidden field for results -->
                    <input type="hidden" name="resultado_json" value="{{ resultado | tojson | e }}">

                    <button type="submit" class="btn btn-success btn-sm btn-download-json">
                        <i class="fas fa-download me-2"></i>Descargar Resultado como JSON
                    </button>
                </form>
                <div class="form-text mt-1">
                    <i class="fas fa-info-circle me-1"></i>
                    Incluye datos de entrada y resultados completos
                </div>
            </div>
        </div>
        {% endif %} <!-- Sección de Iteraciones del Algoritmo movida al lado -->
        {% if resultado and resultado.tableau_history and resultado.tableau_history|length > 0 %}
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="fas fa-table me-2"></i>Iteraciones del Algoritmo
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <small><strong>Fases del algoritmo:</strong>
                        <span class="badge bg-warning text-dark me-1">Fase I</span> (búsqueda de factibilidad)
                        <span class="badge bg-primary me-1">Fase II</span> (optimización)
                    </small>
                </div>
                <div class="accordion" id="iterationsAccordion">
                    {% for i in range(resultado.tableau_history|length) %}
                    {% set is_phase_1 = i < (resultado.phase_switch_iteration if resultado.phase_switch_iteration else
                        resultado.tableau_history|length // 2) %} <div
                        class="accordion-item iteration-phase-{{ 'one' if is_phase_1 else 'two' }}">
                        <h2 class="accordion-header" id="heading{{ i }}">
                            <button
                                class="accordion-button {% if i != 0 %}collapsed{% endif %} phase-{{ 'one' if is_phase_1 else 'two' }}-header"
                                type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ i }}">
                                <span class="badge me-2 {{ 'bg-warning text-dark' if is_phase_1 else 'bg-primary' }}">
                                    {{ 'Fase I' if is_phase_1 else 'Fase II' }}
                                </span>
                                Iteración {{ i + 1 }} {% if resultado.pivot_history and i <
                                    resultado.pivot_history|length %} <small class="ms-2 text-muted">
                                    (Pivote: fila {{ resultado.pivot_history[i][0] }}, columna {{
                                    resultado.pivot_history[i][1] }})
                                    </small>
                                    {% endif %}
                            </button>
                        </h2>
                        <div id="collapse{{ i }}" class="accordion-collapse collapse {% if i == 0 %}show{% endif %}"
                            data-bs-parent="#iterationsAccordion">
                            <div class="accordion-body phase-{{ 'one' if is_phase_1 else 'two' }}-body">
                                <div class="table-responsive">
                                    <table class="table table-sm phase-{{ 'one' if is_phase_1 else 'two' }}-table">
                                        {% for row_idx in range(resultado.tableau_history[i]|length) %}
                                        <tr>
                                            {% for col_idx in range(resultado.tableau_history[i][row_idx]|length) %}
                                            <td
                                                class="{% if resultado.pivot_history and i < resultado.pivot_history|length and row_idx == resultado.pivot_history[i][0] and col_idx == resultado.pivot_history[i][1] %}pivot-cell{% endif %}">
                                                {{ "%.3f"|format(resultado.tableau_history[i][row_idx][col_idx]) }}
                                            </td>
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </table>
                                </div>
                            </div>
                        </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %} {# resultado.tableau_history #}
    {% endif %} {# resultado #}

</div>
</div>

<script src="{{ url_for('static', filename='js/examples.js') }}"></script>
{% endblock %}