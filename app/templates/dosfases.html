{% extends "base.html" %}

{% block title %}Método Dos Fases - Métodos de Optimización{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="fas fa-layer-group text-warning me-2"></i>Método Dos Fases
        </h2>
    </div>
</div>

<div class="row">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-input-number me-2"></i>Datos del Problema
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('main.resolver_dosfases') }}">
                    <div class="mb-3">
                        <label for="c" class="form-label">Función Objetivo (c):</label>
                        <input type="text" class="form-control" id="c" name="c" placeholder="Ej: 3,2,1"
                            value="{{ form_data.c if form_data else '' }}" required>
                        <div class="form-text">Coeficientes separados por comas</div>
                    </div>

                    <div class="mb-3">
                        <label for="A" class="form-label">Matriz de Restricciones (A):</label>
                        <textarea class="form-control" id="A" name="A" rows="4" placeholder="1,2,1&#10;2,1,3&#10;1,1,1"
                            required>{{ form_data.A if form_data else '' }}</textarea>
                        <div class="form-text">Una fila por línea, coeficientes separados por comas</div>
                    </div>

                    <div class="mb-3">
                        <label for="b" class="form-label">Vector de Recursos (b):</label>
                        <input type="text" class="form-control" id="b" name="b" placeholder="Ej: 12,8,6"
                            value="{{ form_data.b if form_data else '' }}" required>
                        <div class="form-text">Valores separados por comas</div>
                    </div>

                    <div class="mb-3">
                        <label for="eq_constraints" class="form-label">Restricciones de Igualdad:</label>
                        <input type="text" class="form-control" id="eq_constraints" name="eq_constraints"
                            placeholder="Ej: 0,2 (opcional)"
                            value="{{ form_data.eq_constraints if form_data else '' }}">
                        <div class="form-text">Índices de restricciones de igualdad (empezando desde 0), separados por
                            comas</div>
                    </div>
                    <div class="mb-3">
                        <label for="ge_constraints" class="form-label">Restricciones de ≥:</label>
                        <input type="text" class="form-control" id="ge_constraints" name="ge_constraints"
                            placeholder="Ej: 1,2 (opcional)"
                            value="{{ form_data.ge_constraints if form_data else '' }}">
                        <div class="form-text">Índices de restricciones de tipo ≥ (empezando desde 0), separados por
                            comas</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="minimize" name="minimize"
                                    {{ 'checked' if form_data and form_data.minimize else '' }}>
                                <label class="form-check-label" for="minimize">
                                    Minimizar (por defecto se maximiza)
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="track_iterations"
                                    name="track_iterations" {{ 'checked' if form_data and form_data.track_iterations
                                    else '' }}>
                                <label class="form-check-label" for="track_iterations">
                                    Mostrar iteraciones
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <button type="submit" class="btn btn-warning text-dark w-100">
                                <i class="fas fa-calculator me-2"></i>Resolver
                            </button>
                        </div>
                        <div class="col-md-6 mb-3">
                            <button type="submit" formaction="{{ url_for('main.generar_animacion_dosfases') }}"
                                class="btn btn-info w-100">
                                <i class="fas fa-play me-2"></i>Resolver con Animación
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        {% if resultado %}
        <div class="result-section">
            {% if resultado.success %}
            <h4 class="text-success mb-3">
                <i class="fas fa-check-circle me-2"></i>Solución Encontrada
            </h4>
            <div class="card mb-3">
                <div class="card-body">
                    {% if resultado.has_multiple_solutions %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>⚠️ Este problema tiene soluciones óptimas múltiples.</strong>
                        {% if resultado.multiple_solution_vars %}
                        <br>
                        <small>Variables candidatas:
                            {% for var in resultado.multiple_solution_vars %}
                            x₍{{ var + 1 }}₎{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </small>
                        {% endif %}
                    </div>

                    <h6>Solución Base:</h6>
                    <div class="row">
                        {% for i in range(resultado.solution|length) %}
                        <div class="col-auto">
                            <span class="badge bg-warning text-dark">x{{ i+1 }} = {{
                                "%.4f"|format(resultado.solution[i]) }}</span>
                        </div>
                        {% endfor %}
                    </div>

                    {% if resultado.alternative_solutions %}
                    <div class="mt-3">
                        <h6><i class="fas fa-list-alt me-2"></i>Soluciones alternativas:</h6>
                        {% for alt_sol in resultado.alternative_solutions %}
                        <div class="card mt-2" style="border-left: 4px solid #ffc107;">
                            <div class="card-body py-2">
                                <small class="text-muted">Pivoteando x₍{{ alt_sol.entering_var + 1 }}₎ → Base</small>
                                <div class="row">
                                    {% for val in alt_sol.solution %}
                                    <div class="col-auto">
                                        <span class="badge bg-outline-warning">x{{ loop.index }} = {{ "%.4f"|format(val)
                                            }}</span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% else %}
                    <h6>Solución Óptima:</h6>
                    <div class="row">
                        {% for i in range(resultado.solution|length) %}
                        <div class="col-auto">
                            <span class="badge bg-warning text-dark">x{{ i+1 }} = {{
                                "%.4f"|format(resultado.solution[i]) }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <hr>
                    <h6>Valor Óptimo: <span class="text-success">{{ "%.4f"|format(resultado.optimal_value) }}</span>
                    </h6>
                    <!-- Botón para descargar JSON -->
                    <div class="json-download-section">
                        <form method="POST" action="{{ url_for('main.descargar_dosfases_json') }}" class="d-inline">
                            <!-- Hidden fields to preserve form data -->
                            <input type="hidden" name="c" value="{{ form_data.c if form_data else '' }}">
                            <input type="hidden" name="A" value="{{ form_data.A if form_data else '' }}">
                            <input type="hidden" name="b" value="{{ form_data.b if form_data else '' }}">
                            <input type="hidden" name="eq_constraints"
                                value="{{ form_data.eq_constraints if form_data else '' }}">
                            <input type="hidden" name="minimize"
                                value="{{ 'on' if form_data and form_data.minimize else '' }}">
                            <input type="hidden" name="track_iterations"
                                value="{{ 'on' if form_data and form_data.track_iterations else '' }}">

                            <!-- Hidden field for results -->
                            <input type="hidden" name="resultado_json" value="{{ resultado | tojson | e }}">

                            <button type="submit" class="btn btn-success btn-sm btn-download-json">
                                <i class="fas fa-download me-2"></i>Descargar Resultado como JSON
                            </button>
                        </form>
                        <div class="form-text mt-1">
                            <i class="fas fa-info-circle me-1"></i>
                            Incluye datos de entrada y resultados completos
                        </div>
                    </div>
                </div>
            </div>

            {% if resultado.tableau_history %}
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-table me-2"></i>Iteraciones del Algoritmo
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <small><strong>Fases del algoritmo:</strong> Las primeras iteraciones corresponden a la Fase I
                            (búsqueda de factibilidad), las siguientes a la Fase II (optimización).</small>
                    </div>
                    <div class="accordion" id="iterationsAccordion">
                        {% for i in range(resultado.tableau_history|length) %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="heading{{ i }}">
                                <button class="accordion-button {% if i != 0 %}collapsed{% endif %}" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#collapse{{ i }}">
                                    Iteración {{ i + 1 }}
                                    {% if i < resultado.pivot_history|length %} <small class="ms-2 text-muted">
                                        (Pivote: fila {{ resultado.pivot_history[i][0] }}, columna {{
                                        resultado.pivot_history[i][1] }})
                                        </small>
                                        {% endif %}
                                </button>
                            </h2>
                            <div id="collapse{{ i }}" class="accordion-collapse collapse {% if i == 0 %}show{% endif %}"
                                data-bs-parent="#iterationsAccordion">
                                <div class="accordion-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm tableau-table">
                                            {% for row_idx in range(resultado.tableau_history[i]|length) %}
                                            <tr>
                                                {% for col_idx in range(resultado.tableau_history[i][row_idx]|length) %}
                                                <td
                                                    class="{% if i < resultado.pivot_history|length and row_idx == resultado.pivot_history[i][0] and col_idx == resultado.pivot_history[i][1] %}pivot-cell{% endif %}">
                                                    {{ "%.3f"|format(resultado.tableau_history[i][row_idx][col_idx]) }}
                                                </td>
                                                {% endfor %}
                                            </tr>
                                            {% endfor %}
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div> {% endif %}
            {% endif %}

            {% if video_url %}
            <div class="card mt-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-film me-2"></i>Animación del Proceso
                    </h5>
                </div>
                <div class="card-body text-center">
                    <video width="100%" height="400" controls>
                        <source src="{{ video_url }}" type="video/mp4">
                        Tu navegador no soporta el elemento de video.
                    </video>
                    <p class="mt-2 text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Animación generada mostrando el proceso de resolución paso a paso
                    </p>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<script src="{{ url_for('static', filename='js/examples.js') }}"></script>
{% endblock %}